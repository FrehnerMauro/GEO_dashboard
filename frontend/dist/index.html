<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GEO Platform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåê</text></svg>">
  
  <!-- CSS Files -->
  <link rel="stylesheet" href="/styles/variables.css">
  <link rel="stylesheet" href="/styles/base.css">
  <link rel="stylesheet" href="/styles/responsive.css">
  
  <!-- API Configuration -->
  <meta name="api-base-url" content="https://geo-platform-backend.maurofrehner.workers.dev">
  <script>
    // Global API configuration - available immediately
    (function() {
      // Get API base URL from meta tag or use default
      const apiBaseUrlMeta = document.querySelector('meta[name="api-base-url"]');
      const apiBaseUrl = apiBaseUrlMeta ? apiBaseUrlMeta.getAttribute('content') : 'https://geo-platform-backend.maurofrehner.workers.dev';
      
      // Store in global config
      window.__GEO_CONFIG__ = {
        apiBaseUrl: apiBaseUrl
      };
      
      // Helper function to get full API URL
      window.getApiUrl = function(endpoint) {
        const baseUrl = window.__GEO_CONFIG__?.apiBaseUrl || '';
        const cleanEndpoint = endpoint.startsWith('/') ? endpoint : '/' + endpoint;
        
        if (baseUrl) {
          const cleanBaseUrl = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
          const fullUrl = cleanBaseUrl + cleanEndpoint;
          console.log('[getApiUrl]', endpoint, '->', fullUrl);
          return fullUrl;
        }
        
        console.log('[getApiUrl]', endpoint, '->', cleanEndpoint, '(no baseUrl)');
        return cleanEndpoint;
      };
      
      // Helper function to make API fetch requests
      window.apiFetch = function(endpoint, options) {
        const url = window.getApiUrl(endpoint);
        return fetch(url, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...(options?.headers || {})
          }
        });
      };
      
      // Override fetch to automatically use API URL for /api/* endpoints
      // This ensures all existing fetch('/api/...') calls work automatically
      const originalFetch = window.fetch;
      window.fetch = function(input, init) {
        // Handle different input types
        if (typeof input === 'string') {
          // If input is a string starting with /api, use getApiUrl
          if (input.startsWith('/api')) {
            const url = window.getApiUrl(input);
            console.log('[API Fetch Override] Intercepted:', input, '->', url);
            const promise = originalFetch.call(this, url, init);
            // Log response for debugging
            promise.then(async response => {
              if (!response.ok) {
                // Try to read response body for more details
                let errorBody = null;
                try {
                  const text = await response.clone().text();
                  try {
                    errorBody = JSON.parse(text);
                  } catch {
                    errorBody = text;
                  }
                } catch (e) {
                  // Could not read body
                }
                
                const errorInfo = {
                  url: url,
                  status: response.status,
                  statusText: response.statusText,
                  originalInput: input,
                  method: init?.method || 'GET',
                  errorBody: errorBody
                };
                
                console.error('[API Fetch Override] Request failed:', errorInfo);
                console.error('[API Fetch Override] Request failed (JSON):', JSON.stringify(errorInfo, null, 2));
              }
            }).catch(error => {
              const errorInfo = {
                url: url,
                error: error?.message || String(error),
                errorStack: error?.stack,
                originalInput: input,
                method: init?.method || 'GET'
              };
              
              console.error('[API Fetch Override] Request error:', errorInfo);
              console.error('[API Fetch Override] Request error (JSON):', JSON.stringify(errorInfo, null, 2));
            });
            return promise;
          }
          // If input is already a full URL to the API, use it as-is
          if (input.startsWith('https://geo-platform-backend.maurofrehner.workers.dev')) {
            return originalFetch.call(this, input, init);
          }
        } else if (input instanceof Request) {
          // If input is a Request object, check its URL
          const url = input.url;
          if (url.startsWith('/api') || (typeof window !== 'undefined' && window.location && url.startsWith(window.location.origin + '/api'))) {
            // Extract the path from the Request URL
            const urlObj = new URL(url, window.location.origin);
            const path = urlObj.pathname;
            if (path.startsWith('/api')) {
              const newUrl = window.getApiUrl(path);
              console.log('[API Fetch Override] Intercepted Request:', path, '->', newUrl);
              // Create a new Request with the updated URL
              const promise = originalFetch.call(this, newUrl, {
                method: input.method,
                headers: input.headers,
                body: input.body,
                ...init
              });
              // Log response for debugging
              promise.then(async response => {
                if (!response.ok) {
                  // Try to read response body for more details
                  let errorBody = null;
                  try {
                    const text = await response.clone().text();
                    try {
                      errorBody = JSON.parse(text);
                    } catch {
                      errorBody = text;
                    }
                  } catch (e) {
                    // Could not read body
                  }
                  
                  const errorInfo = {
                    url: newUrl,
                    status: response.status,
                    statusText: response.statusText,
                    originalPath: path,
                    originalUrl: url,
                    method: input.method || 'GET',
                    errorBody: errorBody
                  };
                  
                  console.error('[API Fetch Override] Request failed:', errorInfo);
                  console.error('[API Fetch Override] Request failed (JSON):', JSON.stringify(errorInfo, null, 2));
                }
              }).catch(error => {
                const errorInfo = {
                  url: newUrl,
                  error: error?.message || String(error),
                  errorStack: error?.stack,
                  originalPath: path,
                  originalUrl: url,
                  method: input.method || 'GET'
                };
                
                console.error('[API Fetch Override] Request error:', errorInfo);
                console.error('[API Fetch Override] Request error (JSON):', JSON.stringify(errorInfo, null, 2));
              });
              return promise;
            }
          }
        }
        // Otherwise, use original fetch
        return originalFetch.call(this, input, init);
      };
    })();
  </script>
  
  <!-- Global JavaScript (must load before body) -->
  <script type="module" src="/scripts/global.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>GEO</h1>
        <p>Engine Optimization</p>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-item active" onclick="showDashboard(event)">
          <span>Dashboard</span>
        </div>
        <div class="nav-item" onclick="showAIAnalysis(event)">
          <span>Prompt Analysis</span>
        </div>
        <div class="nav-item" onclick="showAIReadability(event)">
          <span>AI Readability</span>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="top-header">
        <div style="display: flex; align-items: center; gap: 16px;">
          <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="Hide menu">
            ‚óÄ
          </button>
          <h2 id="headerTitle">Dashboard</h2>
        </div>
        <div id="headerStatus" style="display: flex; gap: 12px; align-items: center;">
          <span style="font-size: 14px; color: var(--gray-500);">Status: Ready</span>
        </div>
      </header>

      <!-- Dashboard Section -->
      <div id="dashboardSection" class="dashboard-section">
        <div class="content-area">
          <div class="welcome-card card" style="margin-bottom: 32px;">
            <div class="card-header">
              <h3>Welcome to GEO Platform</h3>
            </div>
            <div class="card-body">
              <p style="font-size: 16px; line-height: 1.7; color: var(--text-secondary); margin-bottom: 20px;">
                <strong>GEO (Engine Optimization)</strong> is your comprehensive platform for analyzing website content, 
                generating AI-powered insights, and optimizing your online presence. Use the dashboard below to explore 
                your analyses or start a new one.
              </p>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 24px;">
                <div class="feature-card">
                  <div class="feature-card-icon">üìä</div>
                  <h4 class="feature-card-title">Local View</h4>
                  <p class="feature-card-description">
                    Browse analyses organized by company. View detailed results, questions, and summaries for each analysis run.
                  </p>
                </div>
                <div class="feature-card accent">
                  <div class="feature-card-icon">üåê</div>
                  <h4 class="feature-card-title">Global View</h4>
                  <p class="feature-card-description">
                    Explore all questions and answers across all analyses, organized by category. Perfect for finding patterns and insights.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Prompt Analyse Section (hidden by default) -->
      <div id="aiAnalysisSection" class="dashboard-section" style="display: none;">
        <div class="content-area">
          <!-- Info Section -->
          <div class="info-box">
            <div class="info-box-content">
              <div class="info-box-icon">üí°</div>
              <div class="info-box-text">
                <h4 class="info-box-title">How Prompt Analysis Works</h4>
                <p class="info-box-description">
                  This tool analyzes your website content and generates AI-powered questions to evaluate how well your content 
                  answers common user queries. The analysis will:
                </p>
                <ol class="info-box-list">
                  <li><strong>Extract content</strong> from your website (via sitemap or homepage links)</li>
                  <li><strong>Generate categories</strong> based on your content using AI</li>
                  <li><strong>Create questions</strong> for each category to test content coverage</li>
                  <li><strong>Execute questions</strong> with web search to find mentions and citations</li>
                  <li><strong>Provide insights</strong> on content performance and optimization opportunities</li>
                </ol>
              </div>
            </div>
          </div>

          <!-- Configuration Section -->
          <div class="card" id="configurationCard">
            <div class="card-header">
              <h3>Prompt Analysis Configuration</h3>
            </div>
            <div class="card-body">
              <form id="analyzeForm">
                <div class="form-grid">
                  <div class="form-group">
                    <label for="websiteUrl">
                      Website URL *
                    </label>
                    <input type="url" id="websiteUrl" name="websiteUrl" 
                           placeholder="https://example.com" required>
                    <small style="display: block; margin-top: 6px; color: var(--text-light); font-size: 12px;">
                      The system will search for sitemap.xml or extract links from the homepage
                    </small>
                  </div>
                  <div class="form-group">
                    <label for="country">
                      Country (ISO Code) *
                    </label>
                    <input type="text" id="country" name="country" 
                           placeholder="CH, DE, US" maxlength="2" required>
                    <small style="display: block; margin-top: 6px; color: var(--text-light); font-size: 12px;">
                      Two-letter ISO code (e.g., CH, DE, US, FR)
                    </small>
                  </div>
                  <div class="form-group">
                    <label for="language">
                      Language (ISO Code) *
                    </label>
                    <select id="language" name="language" required>
                      <option value="de">German (de)</option>
                      <option value="en">English (en)</option>
                      <option value="fr">French (fr)</option>
                    </select>
                    <small style="display: block; margin-top: 6px; color: var(--text-light); font-size: 12px;">
                      Select the primary language of your website
                    </small>
                  </div>
                  <div class="form-group">
                    <label for="region">
                      Region (optional)
                    </label>
                    <input type="text" id="region" name="region" 
                           placeholder="e.g. Zurich, Berlin, New York">
                    <small style="display: block; margin-top: 6px; color: var(--text-light); font-size: 12px;">
                      Optional: City or region name for localized analysis
                    </small>
                  </div>
                  <div class="form-group">
                    <label for="questionsPerCategory">
                      Questions per Category
                    </label>
                    <input type="number" id="questionsPerCategory" name="questionsPerCategory" 
                           value="3" min="1" max="10" style="width: 100px;">
                    <small style="display: block; margin-top: 6px; color: var(--text-light); font-size: 12px;">
                      Number of questions generated per category (e.g., 3 = 3 questions per category). Recommended: 3-5
                    </small>
                  </div>
                </div>
                <button type="button" id="startAnalysisBtn" class="btn btn-primary btn-block" 
                        onclick="if(window.startAnalysisNow){window.startAnalysisNow();}else{alert('Analysis function not found!');} return false;">
                  üöÄ Start Analysis
                </button>
              </form>
            </div>
          </div>

          <!-- Progress Section (shown during analysis) -->
          <div class="analysis-progress" id="analysisProgress" style="display: none;">
            <div class="progress-header">
              <div class="current-step-indicator">
                <div class="step-number" id="stepNumber">1</div>
                <div class="step-content">
                  <div class="step-title" id="currentStepTitle">Preparing Analysis</div>
                  <div class="step-description" id="currentStepDescription">Initializing...</div>
                </div>
              </div>
              <div class="progress-percentage" id="progressPercentage">0%</div>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar-track">
                <div class="progress-bar-fill" id="progressFill"></div>
              </div>
            </div>
          </div>

          <!-- Loading/Progress (legacy, kept for compatibility) -->
          <div class="loading" id="loading" style="display: none;">
            <div class="progress-container">
              <div class="progress-bar">
                <div class="progress-fill" id="progressFillLegacy" style="width: 0%"></div>
              </div>
              <div class="progress-text" id="progressText">Initializing...</div>
            </div>
            <div class="status-card">
              <div class="status-title" id="currentStatus">Ready to start...</div>
              <div class="status-details" id="statusDetails"></div>
            </div>
          </div>

          <!-- Results -->
          <div id="result" style="display: none; margin-top: 24px;">
            <div class="card">
              <div class="card-header">
                <h3>Analysis Results</h3>
              </div>
              <div class="card-body">
                <div id="resultContent"></div>
              </div>
            </div>
          </div>

          <div id="resultsContainer" style="display: none; margin-top: 24px;">
            <div class="card">
              <div class="card-header">
                <h3>Detailed Analysis Results</h3>
              </div>
              <div class="card-body">
                <div id="resultsContent"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Readability Section (hidden by default) -->
      <div id="aiReadabilitySection" class="dashboard-section" style="display: none;">
        <div class="content-area">
          <!-- Info Section -->
          <div class="info-box">
            <div class="info-box-content">
              <div class="info-box-icon">ü§ñ</div>
              <div class="info-box-text">
                <h4 class="info-box-title">AI Readiness Analysis</h4>
                <p class="info-box-description">
                  Evaluate how well your website is optimized for AI search engines and chatbots. This analysis checks:
                </p>
                <ul class="info-box-list">
                  <li><strong>robots.txt</strong> - Search engine crawling directives</li>
                  <li><strong>Sitemap availability</strong> - XML sitemap for content discovery</li>
                  <li><strong>Content structure</strong> - How well your content is organized</li>
                  <li><strong>AI compatibility</strong> - Readiness score for AI-powered search</li>
                  <li><strong>Recommendations</strong> - Actionable improvements for better AI visibility</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Configuration Section -->
          <div class="card" id="readabilityConfigurationCard">
            <div class="card-header">
              <h3>AI Readiness Configuration</h3>
            </div>
            <div class="card-body">
              <form id="readabilityForm">
                <div class="form-grid">
                  <div class="form-group">
                    <label for="readabilityUrl">
                      Website URL *
                    </label>
                    <input type="url" id="readabilityUrl" name="readabilityUrl" 
                           placeholder="https://example.com" required>
                    <small style="display: block; margin-top: 6px; color: var(--text-light); font-size: 12px;">
                      The analysis will check robots.txt, sitemap, and evaluate content structure
                    </small>
                  </div>
                </div>
                <button type="button" id="fetchContentBtn" class="btn btn-primary btn-block">
                  ü§ñ Start AI Readiness Analysis
                </button>
              </form>
            </div>
          </div>

          <!-- Progress Section (shown during analysis) -->
          <div class="analysis-progress" id="readabilityProgress" style="display: none;">
            <div class="progress-header">
              <div class="current-step-indicator">
                <div class="step-number" id="readabilityStepNumber">1</div>
                <div class="step-content">
                  <div class="step-title" id="readabilityStepTitle">Preparing Analysis</div>
                  <div class="step-description" id="readabilityStepDescription">Initializing...</div>
                </div>
              </div>
              <div class="progress-percentage" id="readabilityProgressPercentage">0%</div>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar-track">
                <div class="progress-bar-fill" id="readabilityProgressFill"></div>
              </div>
            </div>
            <div id="readabilityStepsContainer" style="display: flex; flex-direction: column; gap: 12px; margin-top: 24px; max-height: 400px; overflow-y: auto;"></div>
          </div>
            
          <!-- Results Section -->
          <div id="readabilityContent" style="display: none; margin-top: 24px;">
            <!-- Protocol Display -->
            <div class="card" style="margin-bottom: 24px;">
              <div class="card-header">
                <h3>Protocol</h3>
              </div>
              <div class="card-body">
                <div id="readabilityProtocolDisplay" style="max-height: 400px; overflow-y: auto; padding: 16px; background: var(--bg-secondary); border-radius: 8px; font-family: monospace; font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;"></div>
              </div>
            </div>
              
            <!-- GPT Analysis -->
            <div id="gptAnalysisSection" class="card" style="display: none;">
              <div class="card-header">
                <h3>GPT Analysis & Recommendations</h3>
              </div>
              <div class="card-body">
                <div id="gptAnalysisDisplay"></div>
              </div>
            </div>
              
            <!-- Pages Summary -->
            <div class="card" style="margin-top: 24px;">
              <div class="card-header">
                <h3>Pages Overview</h3>
              </div>
              <div class="card-body">
                <div id="pagesSummaryDisplay"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Analyses Section (hidden by default) -->
      <div id="analysesSection" class="dashboard-section" style="display: none;">
        <div class="card">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
            <h3>Saved Analyses</h3>
            <button class="btn btn-primary" onclick="if(typeof hideAllSections === 'function'){hideAllSections();} (function(){var card = document.querySelector('.content-area > .card'); if(card){card.style.display = 'block';}})();" style="padding: 8px 16px; font-size: 14px;">
              + New Analysis
            </button>
          </div>
          <div class="card-body">
            <div id="analysesList" class="dashboard-grid-2">
              <div style="text-align: center; padding: 40px; color: var(--text-secondary); grid-column: 1 / -1;">
                Loading analyses...
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Analysis Detail Section (hidden by default) -->
      <div id="analysisDetailSection" class="dashboard-section" style="display: none;">
        <div class="card">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
            <h3 id="analysisDetailTitle">Analysis Details</h3>
            <button class="btn" onclick="showAnalyses(event)" style="padding: 8px 16px; font-size: 14px; background: var(--bg-secondary); color: var(--text); border: 1px solid var(--border);">
              ‚Üê Back
            </button>
          </div>
          <div class="card-body">
            <div id="analysisDetailContent" style="width: 100%; box-sizing: border-box;">
              <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                Loading analysis details...
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Main JavaScript (loads after DOM) -->
  <!-- TypeScript modular architecture -->
  <script type="module">
    import { App } from './scripts/app.js';
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        const app = new App();
        app.init();
      });
    } else {
      const app = new App();
      app.init();
    }
  </script>
</body>
</html>

