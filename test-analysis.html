<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Analysis - GEO Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }

    .content {
      padding: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-text {
      display: block;
      margin-top: 5px;
      font-size: 12px;
      color: #666;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #c33;
    }

    .results {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      display: none;
    }

    .results.show {
      display: block;
    }

    .result-section {
      margin-bottom: 25px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .result-section h3 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1.2em;
    }

    .result-item {
      margin: 8px 0;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .result-item strong {
      color: #333;
    }

    .citation-item {
      margin: 10px 0;
      padding: 10px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }

    .citation-item a {
      color: #667eea;
      text-decoration: none;
    }

    .citation-item a:hover {
      text-decoration: underline;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #667eea;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîç Test Analysis Tool</h1>
      <p>Teste die Brand Mention & Citation Analyse</p>
    </div>

    <div class="content">
      <form id="analysisForm">
        <div class="form-group">
          <label for="apiHost">API Host/Base URL *</label>
          <input type="text" id="apiHost" name="apiHost" required placeholder="http://localhost:8787" value="http://localhost:8787">
          <small class="form-text text-muted">Die Basis-URL des API-Servers (z.B. http://localhost:8787 oder https://your-domain.com)</small>
        </div>

        <div class="form-group">
          <label for="domain">Domain (optional)</label>
          <input type="text" id="domain" name="domain" placeholder="z.B. frehnertec.ch, acmecorp.com">
          <small class="form-text text-muted">Die Domain wird verwendet, um den Brand-Namen automatisch zu extrahieren.</small>
        </div>

        <div class="form-group">
          <label for="brandName">Brand Name *</label>
          <input type="text" id="brandName" name="brandName" required placeholder="z.B. FrehnerTec">
        </div>

        <div class="form-group">
          <label for="question">Frage *</label>
          <input type="text" id="question" name="question" required placeholder="z.B. Wo kann ich Kassensysteme in Chur kaufen?">
        </div>

        <div class="form-group">
          <label for="answer">GPT Antwort *</label>
          <textarea id="answer" name="answer" required placeholder="F√ºge hier die GPT-Antwort ein..."></textarea>
        </div>

        <button type="submit" id="submitBtn">Analyse starten</button>
      </form>

      <div id="error" class="error" style="display: none;"></div>

      <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Analysiere...</p>
      </div>

      <div id="results" class="results"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById('analysisForm');
    const errorDiv = document.getElementById('error');
    const loadingDiv = document.getElementById('loading');
    const resultsDiv = document.getElementById('results');
    const submitBtn = document.getElementById('submitBtn');
    const apiHostInput = document.getElementById('apiHost');
    const domainInput = document.getElementById('domain');
    const brandNameInput = document.getElementById('brandName');

    function extractBrandFromDomain(domain) {
      try {
        const hostname = new URL('https://' + domain).hostname;
        const parts = hostname.split('.');
        if (parts.length > 1) {
          return parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
        }
        return domain.charAt(0).toUpperCase() + domain.slice(1);
      } catch {
        return '';
      }
    }

    function extractCitationsFromMarkdown(text) {
      const citations = [];
      // Match markdown links: [text](url)
      const markdownLinkRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
      let match;
      
      while ((match = markdownLinkRegex.exec(text)) !== null) {
        const linkText = match[1];
        const url = match[2];
        citations.push({
          url: url,
          title: linkText,
          snippet: null,
        });
      }
      
      return citations;
    }

    domainInput.addEventListener('input', () => {
      const domain = domainInput.value.trim();
      if (domain) {
        brandNameInput.value = extractBrandFromDomain(domain);
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const apiHost = apiHostInput.value.trim();
      const brandName = brandNameInput.value.trim();
      const domain = domainInput.value.trim();
      const question = document.getElementById('question').value.trim();
      const answer = document.getElementById('answer').value.trim();

      if (!apiHost || !brandName || !question || !answer) {
        showError('Bitte f√ºlle alle Pflichtfelder aus.');
        return;
      }

      // Normalize API host (remove trailing slash)
      const baseUrl = apiHost.replace(/\/$/, '');

      // Hide previous results and errors
      errorDiv.style.display = 'none';
      resultsDiv.style.display = 'none';
      loadingDiv.style.display = 'block';
      submitBtn.disabled = true;

      // Extract citations from markdown links in the answer
      const citations = extractCitationsFromMarkdown(answer);

      try {
        const apiUrl = `${baseUrl}/api/test/analyze`;
        console.log('Sending request to:', apiUrl);
        
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            brandName,
            domain: domain || undefined,
            question,
            answer,
            citations: citations.length > 0 ? citations : undefined,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          console.error('API Error:', data);
          throw new Error(data.error || data.message || 'Fehler bei der Analyse');
        }

        console.log('Analysis Result:', data);
        displayResults(data);
      } catch (error) {
        console.error('Error:', error);
        showError(error.message || 'Ein Fehler ist aufgetreten. Bitte √∂ffne die Browser-Konsole f√ºr Details.');
      } finally {
        loadingDiv.style.display = 'none';
        submitBtn.disabled = false;
      }
    });

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function displayResults(data) {
      const analysis = data.analysis;
      
      let html = '<h2>üìä Analyse Ergebnisse</h2>';

      // Brand Mentions
      html += '<div class="result-section">';
      html += '<h3>Brand Mentions</h3>';
      html += `<div class="result-item"><strong>Exakt:</strong> ${analysis.brandMentions.exact}</div>`;
      html += `<div class="result-item"><strong>Fuzzy:</strong> ${analysis.brandMentions.fuzzy}</div>`;
      html += `<div class="result-item"><strong>Total:</strong> ${analysis.brandMentions.total}</div>`;
      
      if (analysis.brandMentions.contexts && analysis.brandMentions.contexts.length > 0) {
        html += '<div class="result-item"><strong>Kontexte:</strong></div>';
        analysis.brandMentions.contexts.forEach(context => {
          html += `<div class="result-item" style="margin-left: 20px; font-style: italic;">"${context}"</div>`;
        });
      }
      html += '</div>';

      // Citations
      html += '<div class="result-section">';
      html += '<h3>Citations</h3>';
      html += `<div class="result-item"><strong>Total Citations:</strong> ${analysis.citations.total}</div>`;
      html += `<div class="result-item"><strong>Brand Citations:</strong> ${analysis.citations.brandCitations.length}</div>`;
      
      if (analysis.citations.brandCitations && analysis.citations.brandCitations.length > 0) {
        html += '<div class="result-item"><strong>Brand Citation Details:</strong></div>';
        analysis.citations.brandCitations.forEach(citation => {
          html += '<div class="citation-item">';
          html += `<a href="${citation.url}" target="_blank">${citation.url}</a>`;
          if (citation.title) html += `<div style="margin-top: 5px; font-size: 0.9em; color: #666;">${citation.title}</div>`;
          if (citation.context) html += `<div style="margin-top: 5px; font-style: italic; color: #888;">${citation.context}</div>`;
          html += '</div>';
        });
      }

      if (analysis.citations.allCitations && analysis.citations.allCitations.length > 0) {
        html += '<div class="result-item" style="margin-top: 15px;"><strong>Alle Citations:</strong></div>';
        analysis.citations.allCitations.forEach(citation => {
          html += '<div class="citation-item">';
          html += `<a href="${citation.url}" target="_blank">${citation.url}</a>`;
          if (citation.title) html += `<div style="margin-top: 5px; font-size: 0.9em; color: #666;">${citation.title}</div>`;
          html += '</div>';
        });
      }
      html += '</div>';

      // Competitors
      if (analysis.competitors && analysis.competitors.length > 0) {
        html += '<div class="result-section">';
        html += '<h3>Competitors</h3>';
        analysis.competitors.forEach(competitor => {
          html += '<div class="result-item">';
          html += `<strong>${competitor.name}:</strong> ${competitor.count} Erw√§hnungen`;
          if (competitor.contexts && competitor.contexts.length > 0) {
            html += '<div style="margin-left: 20px; font-style: italic; margin-top: 5px;">';
            competitor.contexts.slice(0, 2).forEach(ctx => {
              html += `"${ctx}"<br>`;
            });
            html += '</div>';
          }
          html += '</div>';
        });
        html += '</div>';
      }

      // Sentiment
      html += '<div class="result-section">';
      html += '<h3>Sentiment</h3>';
      html += `<div class="result-item"><strong>Tone:</strong> ${analysis.sentiment.tone}</div>`;
      html += `<div class="result-item"><strong>Confidence:</strong> ${analysis.sentiment.confidence}</div>`;
      if (analysis.sentiment.keywords && analysis.sentiment.keywords.length > 0) {
        html += '<div class="result-item"><strong>Keywords:</strong> ' + analysis.sentiment.keywords.join(', ') + '</div>';
      }
      html += '</div>';

      // Structured Answers
      html += '<div class="result-section">';
      html += '<h3>Structured Answers</h3>';
      html += `<div class="result-item"><strong>Is Mentioned:</strong> <span class="badge ${analysis.isMentioned ? 'badge-success' : 'badge-danger'}">${analysis.isMentioned ? 'Ja' : 'Nein'}</span></div>`;
      html += `<div class="result-item"><strong>Mention Count:</strong> ${analysis.mentionCount}</div>`;
      html += `<div class="result-item"><strong>Is Cited:</strong> <span class="badge ${analysis.isCited ? 'badge-success' : 'badge-warning'}">${analysis.isCited ? 'Ja' : 'Nein'}</span></div>`;
      html += '</div>';

      resultsDiv.innerHTML = html;
      resultsDiv.classList.add('show');
    }
  </script>
</body>
</html>
